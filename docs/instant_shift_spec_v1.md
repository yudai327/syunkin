# 瞬間勤務（席替えメーカー風）Webサービス 仕様たたき台 v1

> 目的：**月ごとの勤務（出勤/休み/出張）**を「条件入力 → ワンクリック自動生成 → ドラッグで微調整」で素早く作る。  
> 方針：**DBなし（ブラウザ完結）**。localStorage + JSON エクスポート/インポート。

---

## 1. 用語 / 前提

- **月**：対象年月（例：2025-12）
- **メンバー**：勤務を割り当てる対象（個人）
- **ステータス**（1人×1日）
  - `ON_SITE`：出勤（現地勤務）
  - `OFF`：休み
  - `TRIP`：出張（勤務扱いだが現地にはいない）
- **固定**：その日にその状態を必ず満たす（希望休＝OFF固定、出張予定＝TRIP固定 など）
- **条件**：割当を「近づける/離す/固定する」などのルール群

---

## 2. ゴール（やること）

- 月ごとに勤務表を作成できる
- 出勤人数が日ごとに偏りすぎないように自動生成できる
- ペア希望（同日出勤）やNG同日（同日出勤回避）を“できる範囲で”反映できる
- **特別休（個人差の追加休み数）**に対応する
- **出張設定**に対応する
- **印刷レイアウト**（A4想定）を用意する
- 永続化：localStorage / JSON Import & Export

---

## 3. 非ゴール（今回やらない）

- ロール/権限/ログイン（ロール不要）
- サーバー/DB/マルチユーザー同時編集/リアルタイム同期
- 早番/遅番などの複雑な勤務区分（必要になったら拡張）

---

## 4. 画面・体験（席替えメーカー風）

### 4.1 メイン画面構成

- **左（メイン）**：月カレンダー（7列×行）
  - 各日セルに **出勤者タグ**を表示（ON_SITE/TRIP）
  - メンバータグを **ドラッグ&ドロップ**で「別日へ移動」
  - セル内で並び替え（見た目の調整）
- **右（サイドバー）**：条件・設定
  - メンバー管理 / 休み数 / 希望 / 出張 / ペア / 生成設定（重み）
- **上部ボタン**
  - `自動生成`（何度でも）
  - `やり直し（直前へ戻す）`
  - `JSON エクスポート`
  - `JSON インポート`
  - `印刷`

### 4.2 編集操作

- 日セルクリック：その日の詳細（出勤人数/警告）を簡易表示
- メンバークリック：その人の月内サマリ（OFF数/ON_SITE数/TRIP数、固定一覧）を表示
- 変更時：localStorageへ自動保存（軽量デバウンス）

---

## 5. 入力データ

### 5.1 月共通設定

- 対象年月（必須）
- 稼働日定義（任意）
  - 例：土日を非稼働として扱う/扱わない、祝日扱い（将来拡張）
- 集計モード（任意）
  - **現地出勤人数**＝ON_SITEのみ
  - **勤務者数**＝ON_SITE + TRIP

### 5.2 メンバー設定（必須）

- `name`：表示名
- `baseOff`：基本休み数（全員共通でもよい）
- `extraOff`：特別休（追加休み数。個人差あり）
  - 休み総数＝`baseOff + extraOff`

### 5.3 希望・固定

- 希望休：該当日の `OFF` 固定
- 出張予定：該当日の `TRIP` 固定
- 出勤希望：該当日を「ON_SITEに寄せる」（固定にするかは設定で選べる）
  - v1では「希望（固定ではない）」として扱う

### 5.4 ペア条件

- **近づける（同日ON_SITEになりやすくする）**
  - 例：AとBは同日にON_SITEが多いほど良い
- **離す（同日ON_SITEを避ける）**
  - 例：AとBは同日ON_SITEをなるべく避けたい

---

## 6. 自動生成（割当）ルール

### 6.1 必須制約（絶対に守る）

1. `OFF` 固定は必ず `OFF`
2. `TRIP` 固定は必ず `TRIP`
3. 各メンバーの `OFF` 総数は **(baseOff + extraOff)** に一致する

※「出勤希望」は v1 では“できる範囲で尊重”の最適化側

### 6.2 最適化（できる範囲で満たす）

- 日別の **現地出勤人数**の偏りを小さくする（分散）
- 出勤希望を満たす（その日はON_SITEに寄せる）
- 近づけるペア（同日ON_SITE）を増やす
- 離すペア（同日ON_SITE）を減らす

### 6.3 生成アルゴリズム（実装方針）

- **ヒューリスティック最適化**（軽量で体験が良い）
  - 初期解：固定を反映しつつ、残りをランダムに割り当て
  - スコア計算：偏り + 付帯条件（ペア/希望） + 罰則
  - 改善：ランダムswap / 近傍探索（必要なら簡易焼きなまし）
  - `自動生成`押下ごとに異なる解（シードを変える）を返す

#### スコア例（概念）
- 偏り：各日 `abs(countOnSite(d) - target)` の合計  
  - v1では target を「月内平均との差」として自動算出
- ペア近づけ：同日ON_SITE回数が多いほど減点（＝良い）
- ペア離す：同日ON_SITE回数が多いほど加点（＝悪い）
- 希望：希望日にON_SITEになっていれば減点（＝良い）

---

## 7. 警告・バリデーション（ユーザーに見せる）

- 固定が多すぎて「休み数」を満たせない
- 希望の衝突が多すぎて分散が破綻している
- 出張（TRIP）が多すぎて現地人数が極端（任意）
- 生成に失敗（探索上限回数を超過）→「条件を緩めてください」ガイド

---

## 8. 印刷（追加要件）

### 8.1 印刷の基本方針

- 画面とは別に **印刷専用レイアウト**を持つ（`@media print`）
- A4縦を基本。月全体を **1枚に収める**優先

### 8.2 レイアウト案（A4 1枚）

- ヘッダ：年月 / タイトル / 作成日時
- 本文：月カレンダー
  - 各日セル：ON_SITE/ TRIP を行単位で表示
  - 表示人数が多い日は `+N` 省略可（印刷用Nは設定）
- フッタ：警告一覧（短く）

### 8.3 印刷CSS要件

- サイドバー/ボタン等は非表示
- 改ページ制御（セルや警告が途中で切れない）
- 背景色に依存しない（記号・枠線でも判別できる）

---

## 9. 永続化（DBなし）

### 9.1 localStorage

- キー例：`instant-shift:{yyyyMM}:{datasetId}`
- 変更時に自動保存（数百msデバウンス）

### 9.2 JSON Import/Export

- Export：現在の月データを 1ファイルJSON
- Import：JSONを読み込んで復元（バージョン互換のため `schemaVersion` を持つ）

#### JSON案（v1）
```json
{
  "schemaVersion": 1,
  "month": "2025-12",
  "settings": {
    "countMode": "ON_SITE_ONLY"
  },
  "members": [
    { "id": "m1", "name": "A", "baseOff": 8, "extraOff": 2 }
  ],
  "fixed": [
    { "date": "2025-12-10", "memberId": "m1", "status": "OFF" },
    { "date": "2025-12-12", "memberId": "m1", "status": "TRIP" }
  ],
  "preferences": {
    "onSitePreferred": [
      { "date": "2025-12-03", "memberId": "m1", "weight": 1 }
    ],
    "pairNear": [
      { "a": "m1", "b": "m2", "weight": 1 }
    ],
    "pairFar": [
      { "a": "m1", "b": "m3", "weight": 1 }
    ]
  },
  "result": {
    "2025-12-01": { "m1": "ON_SITE", "m2": "OFF" }
  }
}
```

---

## 10. 技術スタック（JS前提）

- フロントのみ（SPA）
  - 例：Vite + React（または Next.js）
- ドラッグ&ドロップ：DnDライブラリ（Reactなら `dnd-kit` 等）
- 日付：date-fns 等
- 状態管理：軽量（Zustand等）でもOK
- テスト（任意）：UIは最小限でE2E（Playwright）も可能

---

## 11. 受け入れ基準（v1）

- [ ] 月/メンバー/希望休/出張/特別休 が入力できる
- [ ] 自動生成で「休み総数」が一致し、固定が守られる
- [ ] 日別出勤人数が極端に偏らない（偏り指標を表示）
- [ ] ドラッグで割当を移動でき、即時に集計と警告が更新される
- [ ] localStorageに保存され、リロードで復元できる
- [ ] JSON Export/Import で完全復元できる
- [ ] 印刷でA4レイアウトが崩れず読める

---

## 12. 次の拡張候補（必要になったら）

- 日ごとの目標人数（平日/休日などのプロファイル）
- 祝日カレンダー取込（任意）
- 出勤希望を「固定」扱いにするモード
- 出張の「現地人数に含める/含めない」日別設定
- 複数チーム/月テンプレート

